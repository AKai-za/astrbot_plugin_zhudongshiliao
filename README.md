# 自动私聊插件 (astrbot_plugin_zhudongshiliao)

## 插件介绍

自动私聊插件是一个功能强大的 AstrBot 插件，当用户发送消息时自动进行私聊操作。支持群消息总结、错误信息转发等多种功能，为用户提供更加智能和灵活的消息处理能力。

## 主要功能

### 1. 自动私聊功能
- **主动私聊**：使用 `/private <用户ID/昵称> <消息内容>` 命令主动触发私聊
- **被动私聊**：当用户发送包含特定关键词的消息时自动私聊
- **自然语言命令**：支持使用自然语言触发私聊，如"发给我"、"私信我"等

### 2. 群消息总结
- **关键词触发**：当用户发送"总结"、"汇总"等关键词时自动总结群消息
- **私聊发送**：将总结结果通过私聊发送给用户
- **配置灵活**：可配置总结消息数量、总结模型等

### 3. 错误信息转发
- **自定义格式**：支持自定义错误信息格式
- **指定接收人**：可指定错误信息发送给特定用户
- **发送方式**：支持私聊或群聊发送错误信息

### 4. 昵称解析功能
- **昵称到ID解析**：当发送消息给特定用户时，支持使用昵称而不仅仅是ID
- **用户缓存**：自动缓存用户信息，提高解析准确性

### 5. 管理员功能
- **管理员检测**：支持检测用户是否为管理员
- **权限控制**：可根据管理员身份执行不同操作

## 配置选项

### WebUI 配置

插件提供了直观的 WebUI 配置界面，可在 AstrBot 管理面板中进行配置：

| 配置项 | 描述 | 默认值 |
|--------|------|--------|
| private_send_id | 私发ID，所有私发消息都会发给这个ID | "" |
| summary_keywords | 群消息总结触发关键词 | ["总结", "汇总", "总结一下"] |
| private_keywords | 私聊触发关键词 | ["私聊", "私信", "私发"] |
| auto_summary | 是否自动总结群消息 | false |
| summary_interval | 自动总结间隔（秒） | 300 |
| summary_count | 总结消息数量 | 20 |
| error_send_mode | 错误信息发送方式：private（私聊）或 group（群聊） | "private" |
| error_format | 错误信息格式，支持 {method}、{error} 占位符 | "【错误信息】\n方法: {method}\n错误: {error}" |
| report_status | 是否在群里汇报发送状况 | true |
| summary_provider | 总结模型提供商 | "" |
| vision_provider | 视觉模型提供商 | "" |
| private_prompt | 私发提示词 | "请根据用户的要求，将以下内容发送给用户：{content}" |
| summary_prompt | 总结提示词 | "请总结以下群消息，提取关键信息：{messages}" |
| admin_list | 管理员ID列表 | [] |

### 命令行配置

除了 WebUI 配置外，插件还提供了命令行配置功能：

- **设置私发ID**：`/set_private_id <用户ID>`
- **查看配置**：`/config`

## 使用示例

### 1. 主动私聊

```
/private 123456789 你好，这是一条测试消息
```

### 2. 自然语言触发私聊

```
幽幽，把"测试消息"发给我
```

### 3. 发送消息给特定用户

```
发给张三 你好，这是发给你的消息
```

### 4. 触发群消息总结

```
总结一下最近的消息
```

## 常见问题

### 1. WebUI 配置不同步

**解决方案**：插件已实现实时配置获取功能，WebUI 中的配置更改会立即生效。如果遇到配置不同步问题，请尝试重启插件。

### 2. 总结功能不生效

**解决方案**：
- 确保群消息历史已记录
- 检查总结关键词配置
- 查看插件日志确认是否触发了总结功能

### 3. 昵称解析失败

**解决方案**：
- 确保用户已在群中发送过消息（插件需要缓存用户信息）
- 尝试使用完整昵称
- 如果仍然失败，可直接使用用户ID

### 4. 错误信息格式不生效

**解决方案**：
- 在 WebUI 中检查 error_format 配置
- 确保格式中使用了正确的占位符 {method} 和 {error}

## 日志说明

插件提供了详细的日志信息，可通过 AstrBot 日志系统查看：

- **INFO**：正常操作信息
- **DEBUG**：调试信息，包括配置加载、消息处理等
- **WARNING**：警告信息
- **ERROR**：错误信息，包括详细的错误堆栈

## 版本历史

### v1.2.2
- 修复 send_error_message 方法代码重复问题
- 实现实时配置获取功能，解决 WebUI 配置同步问题
- 增强私聊功能，支持自然语言命令
- 添加昵称到ID解析功能
- 修复 report status toggle 功能
- 修复 summary 功能
- 添加管理员检测功能

### v1.2.1
- 优化消息发送逻辑
- 增加错误处理
- 完善日志系统

### v1.2.0
- 初始版本发布
- 实现基本私聊功能
- 实现群消息总结功能
- 实现错误信息转发功能

## 技术说明

### 插件架构

- **事件驱动**：基于 AstrBot 的事件驱动架构
- **异步编程**：使用 Python 异步编程提高性能
- **实时配置**：实时从数据库获取配置，确保 WebUI 更改立即生效
- **用户缓存**：自动缓存用户信息，提高昵称解析准确性

### 核心方法

- `send_private_message`：发送私聊消息
- `send_error_message`：发送错误信息
- `handle_summary_request`：处理群消息总结请求
- `auto_private_message`：自动私聊功能
- `resolve_user_id`：解析用户标识符（支持昵称）
- `is_admin`：检测用户是否为管理员

## 安装方法

1. 将插件文件夹 `astrbot_plugin_zhudongshiliao` 复制到 AstrBot 的 `data/plugins` 目录
2. 重启 AstrBot
3. 在 AstrBot 管理面板中配置插件

## 注意事项

- 确保 AstrBot 版本 >= v4.0.0
- 配置 `private_send_id` 以接收错误信息和总结结果
- 为了获得最佳体验，建议配置一个稳定的 AI 模型提供商

## 联系与支持

如果您在使用过程中遇到问题，可通过以下方式获取支持：

- **GitHub Issues**：在插件仓库中提交 Issue
- **AstrBot 社区**：参与 AstrBot 社区讨论
- **开发者**：联系插件开发者获取技术支持

---

**插件名称**：自动私聊插件 (astrbot_plugin_zhudongshiliao)
**版本**：v1.2.2
**作者**：引灯续昼
**描述**：自动私聊插件，当用户发送消息时，自动私聊用户。支持群消息总结、错误信息转发等功能。